<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tumble Arena - Canlƒ± Spikerli Online PvP</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Rajdhani', sans-serif;
        background-color: #050b14;
        color: #e2e8f0;
        overflow-x: hidden;
      }
      .font-display { font-family: 'Black Ops One', system-ui; }
      
      /* Animasyonlar */
      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7; } 50% { box-shadow: 0 0 20px #22d3ee, 0 0 30px #22d3ee; } }
      
      .animate-float { animation: float 6s ease-in-out infinite; }
      .animate-glow { animation: glow 3s infinite; }
      
      .glass-panel {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- FIREBASE IMPORT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, serverTimestamp, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, 
            signInWithCustomToken, getFirestore, collection, doc, setDoc, 
            onSnapshot, updateDoc, serverTimestamp, getDoc, deleteDoc
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // ‚öôÔ∏è AYARLAR (BURAYI KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞Nƒ∞ZLE DOLDURUN)
        // ==========================================
        
        // 1. Google Gemini API Anahtarƒ± (Spiker i√ßin gerekli)
        // https://aistudio.google.com/app/apikey adresinden alabilirsiniz.
        const GEMINI_API_KEY = ""; // √ñrn: "AIzaSy..."

        // 2. Firebase Konfig√ºrasyonu (Online oyun i√ßin gerekli)
        // https://console.firebase.google.com/ adresinden proje olu≈üturup web app ekleyerek alabilirsiniz.
        const FIREBASE_CONFIG = {
            apiKey: "DOLDURUN",
            authDomain: "DOLDURUN.firebaseapp.com",
            projectId: "DOLDURUN",
            storageBucket: "DOLDURUN.firebasestorage.app",
            messagingSenderId: "DOLDURUN",
            appId: "DOLDURUN"
        };
        
        // Eƒüer kod edit√∂r√ºnde √ßalƒ±≈üƒ±yorsa otomatik keyleri al (Sizin doldurmanƒ±za gerek yok, bu satƒ±rƒ± silmeyin)
        const activeApiKey = typeof apiKey !== 'undefined' && apiKey ? apiKey : GEMINI_API_KEY;
        const activeFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tumble-arena-v1';

        // ==========================================
        // üéµ SES MOTORU (WEB AUDIO API)
        // ==========================================
        class SoundEngine {
            constructor() {
                this.ctx = null;
                this.bgmOscillators = [];
                this.isMuted = false;
                this.isMusicPlaying = false;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            playTone(freq, type, duration, vol = 0.1) {
                if (this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            // UI Sesleri
            playClick() { this.playTone(800, 'sine', 0.1, 0.05); }
            playJoin() { this.playTone(400, 'triangle', 0.2, 0.1); setTimeout(() => this.playTone(600, 'triangle', 0.2, 0.1), 100); }
            playSpin() { this.playTone(200 + Math.random()*200, 'square', 0.05, 0.03); }
            playWin() { 
                [0, 150, 300].forEach((delay, i) => {
                    setTimeout(() => this.playTone(440 + (i*110), 'sawtooth', 0.5, 0.1), delay);
                });
            }

            // Arka Plan M√ºziƒüi (Drone Ambient)
            toggleMusic() {
                this.init();
                if (this.isMusicPlaying) {
                    this.bgmOscillators.forEach(o => {
                        try { o.stop(); o.disconnect(); } catch(e){}
                    });
                    this.bgmOscillators = [];
                    this.isMusicPlaying = false;
                } else {
                    if (this.isMuted) return;
                    // Bas ve atmosferik drone sesi
                    const freqs = [55, 110, 110.5]; // Binaural beat etkisi i√ßin hafif detune
                    freqs.forEach(f => {
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        osc.type = 'sine';
                        osc.frequency.value = f;
                        gain.gain.value = 0.03; // √áok d√º≈ü√ºk ses
                        osc.connect(gain);
                        gain.connect(this.ctx.destination);
                        osc.start();
                        this.bgmOscillators.push(osc);
                    });
                    this.isMusicPlaying = true;
                }
            }
        }

        const audioManager = new SoundEngine();

        // ==========================================
        // üß† GEMINI AI ENTEGRASYONU
        // ==========================================
        const pcmToWav = (base64PCM) => {
            const binaryString = atob(base64PCM);
            const len = binaryString.length;
            const buffer = new ArrayBuffer(44 + len);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, len, true);
            const bytes = new Uint8Array(buffer, 44);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            return new Blob([buffer], { type: 'audio/wav' });
        };

        const generateSpeech = async (text, setAudioSrc) => {
            if (!activeApiKey) return;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${activeApiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `Heyecanlƒ± bir T√ºrk spor spikeri gibi baƒüƒ±rarak s√∂yle: ${text}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Fenrir" } } }
                }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
                const data = await response.json();
                if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData) {
                    const wavBlob = pcmToWav(data.candidates[0].content.parts[0].inlineData.data);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    setAudioSrc(audioUrl);
                }
            } catch (error) { console.error("TTS Error:", error); }
        };

        const generateCommentaryText = async (prompt) => {
             if (!activeApiKey) return "AI Key eksik.";
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeApiKey}`;
             try {
                const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ƒ∞nanƒ±lmaz bir ma√ß!";
             } catch (e) { return "Baƒülantƒ± hatasƒ±."; }
        };

        // ==========================================
        // üéÆ OYUN Bƒ∞LE≈ûENLERƒ∞ (REACT)
        // ==========================================

        const SYMBOLS = [
            { id: 'skull', icon: 'üíÄ', val: 10, color: 'text-gray-400' },
            { id: 'bolt',  icon: '‚ö°', val: 20, color: 'text-yellow-400' },
            { id: 'fire',  icon: 'üî•', val: 30, color: 'text-orange-500' },
            { id: 'gem',   icon: 'üíé', val: 50, color: 'text-cyan-400' },
            { id: 'crown', icon: 'üëë', val: 100, color: 'text-yellow-500' },
            { id: 'wild',  icon: 'üÉè', val: 200, color: 'text-purple-500' },
        ];

        function App() {
            const [view, setView] = useState('splash'); // splash | menu | lobby | game
            const [user, setUser] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [players, setPlayers] = useState([]);
            const [roomData, setRoomData] = useState(null);
            const [db, setDb] = useState(null);
            const [error, setError] = useState('');

            // Firebase Init
            useEffect(() => {
                const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore } = window.firebaseModules;
                
                try {
                    const app = initializeApp(activeFirebaseConfig);
                    const auth = getAuth(app);
                    const firestore = getFirestore(app);
                    setDb(firestore);

                    const initAuth = async () => {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else {
                            await signInAnonymously(auth);
                         }
                    };
                    initAuth();
                    onAuthStateChanged(auth, setUser);
                } catch (e) {
                    setError("Firebase Ayarlarƒ± Hatalƒ±! Kod i√ßerisindeki FIREBASE_CONFIG alanƒ±nƒ± doldurunuz.");
                }
            }, []);

            // Oda Dinleyicisi
            useEffect(() => {
                if (!db || !roomCode) return;
                const { onSnapshot, doc, collection } = window.firebaseModules;
                
                const unsubRoom = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setRoomData(data);
                        if (data.status === 'playing' && view !== 'game') setView('game');
                        if (data.status === 'waiting' && view === 'game') setView('lobby');
                    } else if (view !== 'menu') {
                        setView('menu'); 
                        setError('Oda kapatƒ±ldƒ±.');
                    }
                });

                const unsubPlayers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode, 'players'), (snap) => {
                    const p = [];
                    snap.forEach(d => p.push({id: d.id, ...d.data()}));
                    setPlayers(p.sort((a,b) => b.score - a.score));
                });

                return () => { unsubRoom(); unsubPlayers(); };
            }, [db, roomCode, view]);

            const enterGame = () => {
                audioManager.init();
                audioManager.playClick();
                audioManager.toggleMusic();
                setView('menu');
            };

            // Oyun ƒ∞≈ülemleri
            const createRoom = async (name) => {
                if (!db || !user) return;
                audioManager.playClick();
                const code = Math.random().toString(36).substring(2,6).toUpperCase();
                const { setDoc, doc, serverTimestamp } = window.firebaseModules;
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code), {
                    hostId: user.uid, status: 'waiting', round: 0, commentary: ''
                });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code, 'players', user.uid), {
                    name, score: 0, isHost: true, lastWin: 0
                });
                setRoomCode(code);
                setView('lobby');
            };

            const joinRoom = async (code, name) => {
                if (!db || !user) return;
                audioManager.playJoin();
                const { getDoc, doc, setDoc } = window.firebaseModules;
                const rRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
                const snap = await getDoc(rRef);
                
                if (!snap.exists()) { setError('Oda bulunamadƒ±!'); return; }
                // 15 ki≈üi kontrol√º
                // (Basitlik i√ßin burada Firestore count yapmƒ±yoruz, ama lobi dolduƒüunda uyarƒ± verebiliriz)
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code, 'players', user.uid), {
                    name, score: 0, isHost: false, lastWin: 0
                });
                setRoomCode(code);
                setView('lobby');
            };

            if (view === 'splash') return <SplashScreen onEnter={enterGame} />;
            if (error && view === 'splash') return <div className="h-screen flex items-center justify-center text-red-500 p-10 bg-black">{error}</div>;

            return (
                <div className="min-h-screen relative overflow-hidden bg-gradient-to-br from-slate-900 via-[#050b14] to-slate-900 text-white">
                    {/* Arka Plan Efekti */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-900/20 blur-[100px] rounded-full animate-float"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-cyan-900/20 blur-[100px] rounded-full animate-float" style={{animationDelay: '2s'}}></div>
                    </div>

                    <div className="relative z-10 container mx-auto px-4 h-full flex flex-col min-h-screen">
                         {/* √úst Bar */}
                         <div className="flex justify-between items-center py-4 border-b border-white/10">
                            <h1 className="text-2xl font-display tracking-widest bg-gradient-to-r from-cyan-400 to-purple-500 text-transparent bg-clip-text">TUMBLE ARENA</h1>
                            <button onClick={() => audioManager.toggleMusic()} className="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">
                                {audioManager.isMusicPlaying ? 'üîä' : 'üîá'}
                            </button>
                        </div>

                        <div className="flex-1 flex flex-col justify-center">
                            {view === 'menu' && <Menu user={user} onCreate={createRoom} onJoin={joinRoom} error={error} />}
                            {view === 'lobby' && <Lobby roomCode={roomCode} players={players} user={user} db={db} />}
                            {view === 'game' && <Game roomCode={roomCode} players={players} user={user} roomData={roomData} db={db} />}
                        </div>
                    </div>
                </div>
            );
        }

        // --- ALT Bƒ∞LE≈ûENLER ---

        function SplashScreen({ onEnter }) {
            return (
                <div className="h-screen w-full bg-black flex flex-col items-center justify-center relative overflow-hidden cursor-pointer" onClick={onEnter}>
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                    <h1 className="text-6xl md:text-8xl font-display text-transparent bg-clip-text bg-gradient-to-br from-purple-500 via-cyan-400 to-blue-600 animate-glow mb-8 text-center px-4">
                        TUMBLE<br/>ARENA
                    </h1>
                    <p className="text-cyan-200/70 font-mono text-lg tracking-[0.3em] animate-pulse mb-12">ONLINE PvP SLOT BATTLE</p>
                    <button className="px-12 py-4 bg-white/5 border border-cyan-500/50 text-cyan-400 rounded-none font-bold tracking-widest hover:bg-cyan-500 hover:text-black transition duration-300 uppercase">
                        Giri≈ü Yap / Sesi A√ß
                    </button>
                    <p className="absolute bottom-10 text-xs text-gray-600">Gemini AI Spiker Destekli ‚Ä¢ Web Audio API Ses Motoru</p>
                </div>
            );
        }

        function Menu({ user, onCreate, onJoin, error }) {
            const [name, setName] = useState('');
            const [code, setCode] = useState('');
            const [tab, setTab] = useState('create'); // create | join

            return (
                <div className="max-w-md mx-auto w-full glass-panel p-8 rounded-2xl shadow-2xl animate-float">
                    <div className="flex gap-4 mb-6">
                        <button onClick={() => { audioManager.playClick(); setTab('create'); }} className={`flex-1 py-3 font-bold tracking-wider transition ${tab==='create' ? 'bg-purple-600 text-white shadow-[0_0_20px_rgba(147,51,234,0.5)]' : 'bg-white/5 text-gray-400'}`}>ODA KUR</button>
                        <button onClick={() => { audioManager.playClick(); setTab('join'); }} className={`flex-1 py-3 font-bold tracking-wider transition ${tab==='join' ? 'bg-cyan-600 text-white shadow-[0_0_20px_rgba(34,211,238,0.5)]' : 'bg-white/5 text-gray-400'}`}>KATIL</button>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="text-xs uppercase text-gray-500 font-bold mb-1 block">Oyuncu Adƒ±</label>
                            <input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-black/40 border border-white/10 p-3 text-white focus:border-cyan-500 outline-none transition" placeholder="NICKNAME" maxLength={12} />
                        </div>
                        
                        {tab === 'join' && (
                             <div>
                                <label className="text-xs uppercase text-gray-500 font-bold mb-1 block">Oda Kodu</label>
                                <input type="text" value={code} onChange={e=>setCode(e.target.value)} className="w-full bg-black/40 border border-white/10 p-3 text-white focus:border-cyan-500 outline-none transition font-mono uppercase tracking-widest" placeholder="ABCD" maxLength={4} />
                            </div>
                        )}

                        {error && <p className="text-red-400 text-sm text-center bg-red-900/20 p-2 rounded">{error}</p>}

                        <button 
                            onClick={() => tab === 'create' ? onCreate(name) : onJoin(code, name)}
                            className={`w-full py-4 mt-4 font-display text-xl uppercase tracking-widest transition hover:scale-[1.02] active:scale-[0.98] ${tab==='create' ? 'bg-gradient-to-r from-purple-600 to-indigo-600' : 'bg-gradient-to-r from-cyan-600 to-blue-600'}`}
                        >
                            {tab === 'create' ? 'ARENAYI OLU≈ûTUR' : 'SAVA≈ûA Gƒ∞R'}
                        </button>
                    </div>
                    <div className="mt-4 text-center text-xs text-gray-600 font-mono">ID: {user?.uid.slice(0,6)}...</div>
                </div>
            );
        }

        function Lobby({ roomCode, players, user, db }) {
            const isHost = players.find(p => p.id === user.uid)?.isHost;
            const startGame = async () => {
                audioManager.playClick();
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), { status: 'playing', round: 1 });
            };

            return (
                <div className="max-w-4xl mx-auto w-full flex flex-col md:flex-row gap-8">
                    <div className="flex-1 glass-panel p-6 rounded-2xl">
                        <h2 className="text-gray-400 uppercase text-xs font-bold tracking-widest mb-4">LOBƒ∞ DURUMU</h2>
                        <div className="text-center py-10">
                            <div className="text-6xl font-display text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-cyan-400 tracking-widest mb-2">{roomCode}</div>
                            <p className="text-gray-400 text-sm animate-pulse">Dƒ∞ƒûER OYUNCULAR BEKLENƒ∞YOR...</p>
                        </div>
                        
                        {isHost ? (
                            <button onClick={startGame} className="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold tracking-widest rounded transition shadow-[0_0_30px_rgba(22,163,74,0.4)] hover:shadow-[0_0_50px_rgba(22,163,74,0.6)]">
                                OYUNU BA≈ûLAT
                            </button>
                        ) : (
                            <div className="w-full py-4 bg-white/5 text-center text-gray-500 rounded font-mono text-sm">KURUCU BA≈ûLATIYOR...</div>
                        )}
                    </div>

                    <div className="flex-1 glass-panel p-6 rounded-2xl flex flex-col h-[500px]">
                        <h2 className="text-gray-400 uppercase text-xs font-bold tracking-widest mb-4 flex justify-between">
                            <span>OYUNCULAR</span>
                            <span>{players.length}/15</span>
                        </h2>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                            {players.map((p, i) => (
                                <div key={p.id} className="flex items-center justify-between p-3 bg-white/5 border border-white/5 rounded hover:bg-white/10 transition">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center font-bold text-xs border border-white/10">
                                            {i + 1}
                                        </div>
                                        <span className={`font-bold ${p.id === user.uid ? 'text-cyan-400' : 'text-gray-300'}`}>{p.name}</span>
                                    </div>
                                    {p.isHost && <span className="text-[10px] bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded">HOST</span>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Game({ roomCode, players, user, roomData, db }) {
            const [grid, setGrid] = useState([]);
            const [status, setStatus] = useState('idle');
            const [roundScore, setRoundScore] = useState(0);
            const [multiplier, setMultiplier] = useState(1);
            
            // AI Spiker State
            const [aiCommentary, setAiCommentary] = useState('');
            const [audioSrc, setAudioSrc] = useState(null);
            const audioRef = useRef(null);

            const isHost = players.find(p => p.id === user.uid)?.isHost;

            // Spiker Sesi √áal
            useEffect(() => {
                if (audioSrc && audioRef.current) {
                    audioRef.current.src = audioSrc;
                    audioRef.current.play().catch(e => console.log("Ses √ßalma hatasƒ±:", e));
                }
            }, [audioSrc]);

            // AI Spiker Tetikleyici (Sadece Host)
            useEffect(() => {
                if (isHost && roomData.status === 'playing' && roomData.commentary) {
                   // Host global commentary'yi deƒüi≈ütirdiƒüinde diƒüerleri sadece text g√∂r√ºr, seslendirme client-side tetiklenmeli
                }
                // Text deƒüi≈ütiƒüinde herkes i√ßin ekranda g√∂ster
                if (roomData.commentary) setAiCommentary(roomData.commentary);
            }, [roomData.commentary]);

            const runGameRound = async () => {
                setStatus('spinning');
                setRoundScore(0);
                setMultiplier(1);
                audioManager.playSpin();

                // 1. Rastgele Grid
                const newGrid = Array(25).fill(null).map(() => SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]);
                setGrid(newGrid);
                
                await new Promise(r => setTimeout(r, 800)); // D√∂nme efekti bekleme

                // 2. Basit Puanlama Sim√ºlasyonu (Karma≈üƒ±k fizik yerine hƒ±zlƒ± oyun i√ßin)
                // Ger√ßek tumble mantƒ±ƒüƒ± burada basitle≈ütirildi
                let totalScore = 0;
                let combos = 0;
                
                // Rastgele 3-4 iterasyon tumble efekti
                for(let i=0; i<3; i++) {
                    setStatus('tumbling');
                    // Rastgele h√ºcreleri "patlat"
                    const popCount = Math.floor(Math.random() * 5) + 1;
                    if (popCount > 0) {
                        combos++;
                        audioManager.playClick(); // Pop sesi
                        totalScore += popCount * 20;
                        await new Promise(r => setTimeout(r, 400));
                        // Yeni semboller (sadece g√∂rsel yenileme)
                        setGrid(prev => prev.map(item => Math.random() > 0.7 ? SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)] : item));
                    }
                }

                // 3. Final √áarpan
                const finalMult = Math.random() > 0.9 ? 5 : (Math.random() > 0.7 ? 2 : 1);
                setMultiplier(finalMult);
                const finalScore = totalScore * finalMult;
                setRoundScore(finalScore);
                
                if (finalScore > 100) audioManager.playWin();

                setStatus('finished');

                // Skoru Kaydet
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode, 'players', user.uid), {
                    score: finalScore, 
                    lastWin: finalScore
                });
            };

            // Round Kontrolc√ºs√º
            useEffect(() => {
                if (roomData.round > 0 && status === 'idle') {
                    runGameRound();
                }
            }, [roomData.round]);

            // Host: Round Bittiƒüinde Yorum Yap ve Sƒ±fƒ±rla
            const handleNextRound = async () => {
                if(!isHost) return;
                
                // En y√ºksek skoru bulan
                const winner = players[0]; // Zaten sƒ±ralƒ±
                
                // AI Yorumu √úret
                const prompt = `Tumble Arena oyununda ${winner.name} isimli oyuncu ${winner.score} puanla lider! √áok kƒ±sa, tek c√ºmlelik, gaza getirici bir spiker yorumu yap. T√ºrk√ße olsun.`;
                const text = await generateCommentaryText(prompt);
                
                // Text'i DB'ye yaz (Herkes g√∂rs√ºn)
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), {
                    commentary: text,
                    // round stat√ºs√ºn√º deƒüi≈ütirmek yerine client tarafƒ±nda reset bekliyoruz
                });

                // Sesi sadece host veya herkes √ºretebilir. 
                // Trafik tasarrufu i√ßin sesi sadece kendi client'ƒ±nda √ºretip dinletelim, diƒüerleri metni okur.
                // Veya herkes √ºretsin:
                generateSpeech(text, setAudioSrc);
            };

            const triggerReset = async () => {
                 if(!isHost) return;
                 const { updateDoc, doc } = window.firebaseModules;
                 setStatus('idle');
                 setAiCommentary('');
                 // Yeni round i√ßin sayƒ±yƒ± artƒ±r
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), { 
                     round: roomData.round + 1,
                     commentary: ''
                 });
            };

            return (
                <div className="flex flex-col md:flex-row gap-6 max-w-6xl mx-auto w-full h-[85vh]">
                    <audio ref={audioRef} className="hidden" />
                    
                    {/* SOL PANEL: OYUN ALANI */}
                    <div className="flex-[2] flex flex-col relative">
                        {/* Spiker Kutusu */}
                        {aiCommentary && (
                            <div className="absolute top-4 left-0 right-0 z-20 mx-auto w-max max-w-[90%] bg-purple-900/90 border border-purple-500 p-4 rounded-xl backdrop-blur animate-in slide-in-from-top fade-in duration-500 shadow-[0_0_30px_rgba(168,85,247,0.5)]">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">üéôÔ∏è</span>
                                    <p className="text-white font-bold italic">"{aiCommentary}"</p>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 bg-slate-900/50 border border-white/10 rounded-3xl relative flex items-center justify-center p-4 overflow-hidden shadow-2xl">
                             <div className="grid grid-cols-5 gap-2 w-full max-w-[500px] aspect-square">
                                {grid.map((item, i) => (
                                    <div key={i} className={`bg-slate-800 rounded-lg flex items-center justify-center text-4xl shadow-inner border border-white/5 transition-all duration-300 ${status === 'tumbling' ? 'scale-90' : 'scale-100'}`}>
                                        <span className={item?.color || 'text-white'}>{item?.icon}</span>
                                    </div>
                                ))}
                             </div>

                             {/* Sonu√ß Overlay */}
                             {status === 'finished' && (
                                 <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-10 flex flex-col items-center justify-center">
                                     <h3 className="text-purple-400 font-bold tracking-widest text-xl mb-2">TUR KAZANCI</h3>
                                     <div className="text-7xl font-display text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] mb-4">{roundScore}</div>
                                     {multiplier > 1 && <div className="text-yellow-400 font-bold text-2xl animate-bounce">x{multiplier} √áARPAN!</div>}
                                     
                                     {isHost && (
                                         <div className="mt-8 flex gap-4">
                                            {!aiCommentary ? (
                                                <button onClick={handleNextRound} className="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded font-bold transition">
                                                    üéôÔ∏è YORUM YAP
                                                </button>
                                            ) : (
                                                <button onClick={triggerReset} className="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded font-bold transition animate-pulse">
                                                    SONRAKƒ∞ ROUND ‚û°Ô∏è
                                                </button>
                                            )}
                                         </div>
                                     )}
                                     {!isHost && <p className="mt-8 text-gray-400 animate-pulse">HOST BEKLENƒ∞YOR...</p>}
                                 </div>
                             )}
                        </div>
                    </div>

                    {/* SAƒû PANEL: Lƒ∞DERLƒ∞K TABLOSU (15 Ki≈üilik Scrollable) */}
                    <div className="flex-1 glass-panel border-l border-white/10 flex flex-col overflow-hidden rounded-2xl md:rounded-none md:rounded-r-2xl h-full">
                        <div className="p-4 border-b border-white/10 bg-black/20">
                            <h3 className="font-display tracking-widest text-cyan-400 text-lg">CANLI SKOR</h3>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                            {players.map((p, i) => (
                                <div key={p.id} className={`flex items-center justify-between p-3 rounded-xl border transition-all duration-500 ${p.id === user.uid ? 'bg-cyan-900/30 border-cyan-500/50' : 'bg-white/5 border-transparent'} ${i===0 ? 'scale-105 my-2 shadow-[0_0_15px_rgba(234,179,8,0.2)] bg-yellow-900/10 border-yellow-500/30' : ''}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 flex items-center justify-center rounded font-bold text-sm ${i===0 ? 'text-yellow-400' : 'text-gray-400'}`}>
                                            {i===0 ? 'üëë' : `#${i+1}`}
                                        </div>
                                        <div>
                                            <div className="font-bold text-sm">{p.name}</div>
                                            <div className="text-[10px] text-gray-500">Son: {p.lastWin || 0}</div>
                                        </div>
                                    </div>
                                    <div className="font-mono font-bold text-lg">{p.score}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
