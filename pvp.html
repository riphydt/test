<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tumble Arena - Sesli Spikerli PvP</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN'leri -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Modülleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Firestore'da hata ayıklama (debug) seviyesini aç
        // setLogLevel('debug'); // Gerekirse açılabilir

        // Firebase yapılandırmasını global değişkenlerden al
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.appId = appId;
            window.signInWithCustomToken = signInWithCustomToken;
            window.signInAnonymously = signInAnonymously;
            window.onAuthStateChanged = onAuthStateChanged;
            window.doc = doc;
            window.onSnapshot = onSnapshot;
            window.collection = collection;
            window.query = query;
            window.setDoc = setDoc;
            window.updateDoc = updateDoc;
            window.arrayUnion = arrayUnion;
            window.arrayRemove = arrayRemove;
        } else {
            console.error("Firebase yapılandırması bulunamadı.");
        }
    </script>
    <style>
      /* Temel stil ayarlamaları */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a;
      }
      /* Grid öğeleri için custom animasyon */
      .grid-cell-container {
        transform-origin: center;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .scale-0 { transform: scale(0); opacity: 0; }
      .scale-100 { transform: scale(1); opacity: 1; }
      
      /* Özel kaydırma çubuğu stili */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #475569; /* slate-600 */
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background-color: #1e293b; /* slate-800 */
      }
    </style>
</head>
<body>
    <div id="root" class="flex items-center justify-center min-h-screen p-4">
        <!-- React uygulaması buraya render edilecek -->
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- Sabitler ve Yardımcı Fonksiyonlar ---
        const API_KEY = ""; // Gemini API Anahtarı
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const TOTAL_CELLS = 49; // 7x7 grid
        
        // Firestore için yol oluşturucu
        const getPublicCollectionRef = (db, appId, collectionName) => {
            return db.collection(`/artifacts/${appId}/public/data/${collectionName}`);
        };

        // Oturum Veri Yolunu Al
        const getSessionDocRef = (db, appId, sessionId) => {
            return window.doc(db, `/artifacts/${appId}/public/data/sessions/${sessionId}`);
        };

        // Basit SVG İKONLARI (lucide-react yerine) - Hata düzeltmesi için hayati
        const ICONS = {
            MessageSquare: ({ size = 24, className = '' }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            ),
            RefreshCw: ({ size = 24, className = '' }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            ),
            Zap: ({ size = 24, className = '' }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
            ),
            User: ({ size = 24, className = '' }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>
                </svg>
            )
        };


        // --- Bileşenler ---

        // Lobi Ekranı Bileşeni
        function Lobby({ players, onStart, onJoin, onLeave, userId, currentSessionId }) {
            const hasJoined = players.some(p => p.id === userId);
            const canStart = players.length >= 2;

            const myPlayer = players.find(p => p.id === userId) || { name: 'Oyuncu' };
            const username = myPlayer.name || 'Oyuncu';

            return (
                <div className="w-full max-w-sm bg-slate-800 rounded-xl shadow-2xl p-6">
                    <h1 className="text-3xl font-extrabold text-white mb-2 text-center">Tumble Arena</h1>
                    <p className="text-slate-400 text-center mb-6">Sesli Spikerli Çevrimiçi Arena</p>
                    
                    <div className="bg-slate-900 rounded-lg p-4 mb-4">
                        <h2 className="text-lg font-semibold text-slate-300 mb-3 flex items-center">
                             <ICONS.User size={18} className="mr-2 text-cyan-400" /> Katılımcılar ({players.length})
                        </h2>
                        <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
                            {players.map(p => (
                                <div key={p.id} className={`flex items-center justify-between p-2 rounded-md transition ${p.id === userId ? 'bg-cyan-900/50 border border-cyan-500' : 'bg-slate-700'}`}>
                                    <span className={`font-medium ${p.id === userId ? 'text-white' : 'text-slate-200'}`}>{p.name}</span>
                                    <span className="text-xs text-slate-400 truncate w-24 text-right" title={p.id}>{p.id}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="space-y-3">
                        {!hasJoined ? (
                            <button 
                                onClick={() => onJoin(username)} 
                                className="w-full py-3 rounded-lg bg-cyan-600 hover:bg-cyan-500 font-bold text-white text-sm transition shadow-lg shadow-cyan-900/50"
                            >
                                ARENA'YA KATIL
                            </button>
                        ) : (
                            <>
                                <button 
                                    onClick={onLeave} 
                                    className="w-full py-3 rounded-lg bg-red-600 hover:bg-red-500 font-bold text-white text-sm transition"
                                >
                                    AYRIL
                                </button>
                                <button 
                                    onClick={onStart} 
                                    disabled={!canStart}
                                    className={`w-full py-3 rounded-lg font-bold text-white text-sm transition ${canStart ? 'bg-purple-600 hover:bg-purple-500 shadow-lg shadow-purple-900/50' : 'bg-slate-700 cursor-not-allowed'}`}
                                >
                                    {canStart ? 'OYUNU BAŞLAT' : 'OYUN İÇİN MİN. 2 OYUNCU GEREKLİ'}
                                </button>
                            </>
                        )}
                    </div>
                    
                    <p className="text-xs text-slate-500 mt-4 text-center break-all">
                        Oturum ID: <span className="font-mono text-slate-400">{currentSessionId}</span>
                    </p>
                </div>
            );
        }

        // Oyun Ekranı Bileşeni
        function Game({ players, grid, onReset, onCellClick, onGenerateShout, generatingShout, userId, winner }) {
            const numColumns = Math.sqrt(TOTAL_CELLS);
            const playerColors = useMemo(() => ({
                1: 'bg-red-500 hover:bg-red-400',
                2: 'bg-blue-500 hover:bg-blue-400',
                3: 'bg-green-500 hover:bg-green-400',
                4: 'bg-yellow-500 hover:bg-yellow-400',
            }), []);

            return (
                <div className="w-full max-w-lg bg-slate-800 rounded-xl shadow-2xl overflow-hidden flex flex-col">
                    <div className="p-4 bg-slate-900 border-b border-slate-700 text-center">
                        <h1 className="text-xl font-extrabold text-white">ARENA MÜCADELESİ</h1>
                        <p className="text-sm text-slate-400">{winner ? 'Oyun Bitti!' : 'En çok alana sahip olan kazanır.'}</p>
                    </div>

                    {/* Grid Alanı */}
                    <div className="p-4 flex justify-center">
                        <div 
                            className="grid aspect-square bg-slate-900 border border-slate-700 rounded-xl shadow-inner shadow-slate-900/50 p-1"
                            style={{ 
                                gridTemplateColumns: `repeat(${numColumns}, 1fr)`, 
                                width: '100%', 
                                maxWidth: '400px'
                            }}
                        >
                            {grid.map((cell, index) => {
                                const playerIndex = players.findIndex(p => p.id === cell.ownerId);
                                const isOwned = cell.ownerId !== null;
                                const isMyCell = cell.ownerId === userId;
                                const isWinnerCell = winner && cell.ownerId === winner.id;
                                
                                return (
                                    <div 
                                        key={index} 
                                        className="grid-cell-container p-[2px]"
                                        onClick={() => onCellClick(index)}
                                    >
                                        <div 
                                            className={`w-full h-full rounded-md flex items-center justify-center text-xs font-bold transition-all duration-300 transform 
                                                ${isOwned 
                                                    ? playerColors[playerIndex + 1] + (isWinnerCell ? ' ring-4 ring-cyan-400/50' : '')
                                                    : 'bg-slate-700 hover:bg-slate-600 cursor-pointer'
                                                }
                                                ${cell.isClicked ? 'scale-100' : 'scale-0'}`
                                            }
                                        >
                                            {isOwned && <span className="text-white drop-shadow-sm">{cell.strength}</span>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Skor ve Kontroller */}
                    <div className="p-4 bg-slate-900 border-t border-slate-700">
                        <h2 className="text-lg font-bold text-slate-200 mb-3">Skor Tablosu</h2>
                        <div className="space-y-2 mb-4">
                            {players.map((p, index) => {
                                const winner = players.reduce((max, player) => (player.score > max.score ? player : max), { score: -1 });
                                return (
                                    <div key={p.id} className={`relative flex items-center justify-between p-3 rounded-xl transition-all duration-300 ${p.id === userId ? 'bg-cyan-900/50' : 'bg-slate-700'}`}>
                                        <div className="flex items-center gap-3">
                                            <span className={`w-3 h-3 rounded-full ${playerColors[index + 1].split(' ')[0]}`}></span>
                                            <span className={`font-semibold ${p.id === userId ? 'text-white' : 'text-slate-200'}`}>{p.name} {p.id === userId && '(Siz)'}</span>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className={`text-xl font-extrabold ${p.id === userId ? 'text-cyan-400' : 'text-white'}`}>{p.score}</span>
                                            {p.score === winner.score && winner.score > 0 && <ICONS.Zap size={16} className="text-yellow-400 drop-shadow-lg" />}
                                        </div>
                                        
                                        {/* Hype/Spiker Butonu */}
                                        {p.id === userId && !generatingShout && !winner && (
                                            <button 
                                                onClick={onGenerateShout} 
                                                disabled={generatingShout}
                                                className="absolute top-1/2 -translate-y-1/2 right-2 px-2 py-1 bg-slate-800/80 backdrop-blur-sm rounded-full text-xs font-medium flex items-center gap-1 text-slate-300 transition hover:bg-slate-700/80"
                                            >
                                                {generatingShout ? <ICONS.RefreshCw size={10} className="animate-spin"/> : <ICONS.MessageSquare size={10} />}
                                                ✨ Hype Ver!
                                            </button>
                                        )}
                                        
                                        {/* Skor Çubuğu */}
                                        {winner && winner.score > 0 && (
                                            <div className="absolute bottom-0 left-0 h-1 bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-700 rounded-b-xl" style={{ width: `${Math.min(100, (p.score / winner.score) * 100)}%` }}></div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={onReset} className="w-full py-3 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-sm text-slate-300 transition">LOBİYE GERİ DÖN</button>
                    </div>
                </div>
            );
        }

        // Ana Uygulama Bileşeni
        function App() {
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [currentSessionId] = useState('tumble-arena-session-1'); // Sabit oturum ID'si
            const [sessionData, setSessionData] = useState(null);
            const [generatingShout, setGeneratingShout] = useState(false);
            const [currentShout, setCurrentShout] = useState('');
            const [audioQueue, setAudioQueue] = useState([]);


            // --- Firebase ve Kimlik Doğrulama ---
            useEffect(() => {
                const initializeFirebase = async () => {
                    const { auth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window;
                    
                    if (!auth) {
                        console.error("Firebase Auth yüklenemedi.");
                        return;
                    }
                    
                    try {
                        // Özel token ile giriş yap veya anonim olarak devam et
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Kimlik doğrulama hatası:", error);
                        await signInAnonymously(auth); // Hata durumunda anonim dene
                    }

                    // Kimlik doğrulama durumunu dinle
                    const unsubscribe = onAuthStateChanged(auth, user => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            // Anonim kullanıcı veya başka bir kimlik doğrulama yolu
                            setUserId(auth.currentUser?.uid || crypto.randomUUID());
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                };

                if (window.auth) {
                    initializeFirebase();
                } else {
                    // Firebase CDN'lerinin yüklenmesini bekle
                    setTimeout(initializeFirebase, 500);
                }
            }, []);

            // --- Firestore Veri Dinleme ---
            useEffect(() => {
                if (!isAuthReady || !window.db) return;
                
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);

                // Oturum belgesini dinle
                const unsubscribe = window.onSnapshot(sessionRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSessionData(docSnap.data());
                    } else {
                        // Oturum yoksa, varsayılan bir oturum oluştur
                        console.log("Oturum belgesi bulunamadı, oluşturuluyor...");
                        const initialGrid = Array(TOTAL_CELLS).fill(null).map((_, index) => ({
                            index,
                            ownerId: null,
                            strength: 0,
                            isClicked: false,
                        }));

                        window.setDoc(sessionRef, {
                            isGameStarted: false,
                            players: [],
                            grid: initialGrid,
                            turn: null, // Sıradaki oyuncu ID'si
                            shouts: [],
                            winnerId: null
                        }, { merge: true }).catch(e => console.error("Oturum oluşturma hatası:", e));
                    }
                }, error => console.error("Firestore dinleme hatası:", error));

                return () => unsubscribe();
            }, [isAuthReady, currentSessionId]);

            // --- Ses Oynatma Mantığı ---
            useEffect(() => {
                if (audioQueue.length > 0) {
                    const { text, speaker, callback } = audioQueue[0];
                    if (!text) {
                         // Geçersiz öğeyi kuyruktan çıkar
                        setAudioQueue(q => q.slice(1));
                        return;
                    }

                    const audio = document.createElement('audio');
                    audio.onended = () => {
                        setAudioQueue(q => q.slice(1)); // Oynatma bitince kuyruktan çıkar
                        if (callback) callback();
                    };
                    audio.onerror = (e) => {
                        console.error("Ses oynatma hatası:", e);
                        setAudioQueue(q => q.slice(1)); // Hata durumunda da kuyruktan çıkar
                        if (callback) callback();
                    };

                    const fetchTTS = async () => {
                        try {
                            const selectedVoice = speaker === 'Kore' ? 'Kore' : 'Puck'; // Basit ses seçimi
                            
                            const payload = {
                                contents: [{ parts: [{ text: `Konuşmacı ${speaker}: ${text}` }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        multiSpeakerVoiceConfig: {
                                            speakerVoiceConfigs: [
                                                { speaker: "Joe", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } },
                                                { speaker: "Jane", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                                            ]
                                        }
                                    }
                                },
                                model: "gemini-2.5-flash-preview-tts"
                            };

                            const response = await fetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) throw new Error(`API Hatası: ${response.statusText}`);

                            const result = await response.json();
                            const part = result?.candidates?.[0]?.content?.parts?.[0];
                            const audioData = part?.inlineData?.data;
                            const mimeType = part?.inlineData?.mimeData;
                            
                            if (audioData) {
                                // PCM'i WAV'a dönüştürme mantığı (basit bir yaklaşım kullanıldı)
                                const audioUrl = `data:audio/wav;base64,${audioData}`; // Bu genellikle işe yarar
                                audio.src = audioUrl;
                                audio.play().catch(e => console.error("Oynatma reddedildi:", e));
                            } else {
                                throw new Error("Ses verisi alınamadı.");
                            }
                        } catch (e) {
                            console.error("TTS üretme/oynatma hatası:", e);
                            setAudioQueue(q => q.slice(1));
                        }
                    };

                    fetchTTS();
                }
            }, [audioQueue]); 

            // --- İşleyiciler (Handlers) ---

            // Oyuncunun ismini lobiye ekler/günceller
            const joinGame = useCallback(async (name) => {
                if (!window.db || !userId) return;
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                const newPlayer = { id: userId, name: name, score: 0 };
                
                try {
                    // Oyuncunun zaten listede olup olmadığını kontrol et ve güncelle
                    const updatedPlayers = sessionData.players.filter(p => p.id !== userId);
                    await window.setDoc(sessionRef, {
                        players: [...updatedPlayers, newPlayer],
                    }, { merge: true });
                } catch (e) {
                    console.error("Oyuna katılma hatası:", e);
                }
            }, [userId, currentSessionId, sessionData]);

            // Oyuncuyu lobiden çıkarır
            const leaveGame = useCallback(async () => {
                if (!window.db || !userId) return;
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                
                try {
                    const updatedPlayers = sessionData.players.filter(p => p.id !== userId);
                    await window.updateDoc(sessionRef, {
                        players: updatedPlayers,
                    });
                } catch (e) {
                    console.error("Oyundan ayrılma hatası:", e);
                }
            }, [userId, currentSessionId, sessionData]);

            // Oyunu başlatır
            const startGame = useCallback(async () => {
                if (!window.db || !sessionData || sessionData.players.length < 2) return;
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                
                const shuffledPlayers = [...sessionData.players].sort(() => Math.random() - 0.5);
                const firstPlayerId = shuffledPlayers[0].id;
                
                const initialGrid = Array(TOTAL_CELLS).fill(null).map((_, index) => ({
                    index,
                    ownerId: null,
                    strength: 0,
                    isClicked: false,
                }));

                try {
                    await window.setDoc(sessionRef, {
                        isGameStarted: true,
                        turn: firstPlayerId,
                        grid: initialGrid,
                        winnerId: null,
                        shouts: []
                    }, { merge: true });
                    setAudioQueue(q => [...q, { text: `Oyun başladı! Sıra ${shuffledPlayers[0].name} oyuncusunda.`, speaker: 'Joe' }]);
                } catch (e) {
                    console.error("Oyunu başlatma hatası:", e);
                }
            }, [currentSessionId, sessionData]);

            // Oyunu sıfırlar (lobiye döner)
            const resetGame = useCallback(async () => {
                if (!window.db || !sessionData) return;
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                
                try {
                    await window.updateDoc(sessionRef, {
                        isGameStarted: false,
                        turn: null,
                        winnerId: null,
                        grid: Array(TOTAL_CELLS).fill(null).map((_, index) => ({
                            index,
                            ownerId: null,
                            strength: 0,
                            isClicked: false,
                        })),
                        players: sessionData.players.map(p => ({ ...p, score: 0 }))
                    });
                    setAudioQueue(q => [...q, { text: `Oyun sona erdi ve lobiye dönüldü.`, speaker: 'Joe' }]);
                } catch (e) {
                    console.error("Oyunu sıfırlama hatası:", e);
                }
            }, [currentSessionId, sessionData]);

            // Oyunda hücre tıklaması
            const handleCellClick = useCallback(async (cellIndex) => {
                if (!window.db || !sessionData || sessionData.turn !== userId || sessionData.winnerId) return;
                
                const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                const grid = [...sessionData.grid];
                const cell = grid[cellIndex];

                // Sadece boş hücreye tıklanabilir
                if (cell.ownerId === null) {
                    grid[cellIndex] = {
                        index: cellIndex,
                        ownerId: userId,
                        strength: 1,
                        isClicked: true
                    };

                    // Skor güncelleme
                    const newScore = sessionData.players.find(p => p.id === userId).score + 1;
                    const newPlayers = sessionData.players.map(p => p.id === userId ? { ...p, score: newScore } : p);

                    // Sıradaki oyuncuyu bul
                    const currentPlayerIndex = newPlayers.findIndex(p => p.id === userId);
                    const nextPlayerIndex = (currentPlayerIndex + 1) % newPlayers.length;
                    const nextPlayerId = newPlayers[nextPlayerIndex].id;

                    // Kazanan kontrolü (tüm hücreler doluysa)
                    const isGameOver = grid.every(c => c.ownerId !== null);
                    let winnerId = isGameOver ? newPlayers.reduce((max, p) => (p.score > max.score ? p : max)).id : null;

                    try {
                        await window.updateDoc(sessionRef, {
                            grid: grid,
                            players: newPlayers,
                            turn: isGameOver ? null : nextPlayerId,
                            winnerId: winnerId
                        });

                        if (!isGameOver) {
                            const nextPlayerName = newPlayers[nextPlayerIndex].name;
                            setAudioQueue(q => [...q, { text: `Oyuncu ${newPlayers[currentPlayerIndex].name} bir alan ele geçirdi. Sıra ${nextPlayerName} oyuncusunda.`, speaker: 'Joe' }]);
                        } else {
                            const winnerName = newPlayers.find(p => p.id === winnerId).name;
                             setAudioQueue(q => [...q, { text: `Oyun Bitti! Kazanan ${winnerName}.`, speaker: 'Joe' }]);
                        }

                    } catch (e) {
                        console.error("Hücre tıklama hatası:", e);
                    }
                }
            }, [userId, currentSessionId, sessionData]);
            
            // Oyuncunun durumu hakkında Gemini'dan yorum ister (hype)
            const generateShout = useCallback(async () => {
                if (!window.db || !sessionData || generatingShout || sessionData.winnerId) return;
                setGeneratingShout(true);

                const myPlayer = sessionData.players.find(p => p.id === userId);
                const opponentScores = sessionData.players.filter(p => p.id !== userId).map(p => `${p.name}: ${p.score}`).join(', ');
                const myScore = myPlayer ? myPlayer.score : 0;
                const turnName = sessionData.players.find(p => p.id === sessionData.turn)?.name || 'Bilinmiyor';
                
                const prompt = `You are a hype announcer for a simple tile-capturing game. The current player, ${myPlayer.name}, has a score of ${myScore}. Opponent scores are: ${opponentScores}. It is currently ${turnName}'s turn. Write a single, short, exciting Turkish sentence (max 15 words) encouraging the player or commenting on the state of the game. Focus on action and excitement.`;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "Act as a highly energetic sports announcer. Respond only with a single, short, exciting Turkish sentence." }] },
                        tools: [{ "google_search": {} }],
                    };

                    const response = await fetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Hatası: ${response.statusText}`);
                    const result = await response.json();
                    const shoutText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Vay canına, heyecan dorukta!";
                    
                    setCurrentShout(shoutText);
                    setAudioQueue(q => [...q, { text: shoutText, speaker: 'Jane' }]);

                    // Yorumu Firestore'a kaydet (isteğe bağlı: sadece son yorumu tutmak için)
                    const sessionRef = getSessionDocRef(window.db, window.appId, currentSessionId);
                    await window.updateDoc(sessionRef, {
                        shouts: window.arrayUnion({ text: shoutText, by: myPlayer.name, timestamp: Date.now() })
                    });

                } catch (e) {
                    console.error("Yorum üretme hatası:", e);
                    setCurrentShout("Bir spiker yorumu üretilemedi.");
                } finally {
                    setGeneratingShout(false);
                }
            }, [userId, currentSessionId, sessionData, generatingShout]);


            // Yükleniyor veya oturum yoksa bekle
            if (!isAuthReady || !sessionData) {
                return (
                    <div className="text-white text-lg flex items-center gap-2">
                        <ICONS.RefreshCw size={24} className="animate-spin text-cyan-400" />
                        <p>Oyun verileri yükleniyor...</p>
                    </div>
                );
            }
            
            // Mevcut kazananı belirle
            const winner = sessionData.winnerId ? 
                           sessionData.players.reduce((max, p) => (p.score > max.score ? p : max)) : 
                           null;

            // Ana uygulama görünümü
            return (
                <div className="min-h-screen flex items-center justify-center p-4 w-full">
                    {/* Spiker Yorumu Kutusu */}
                    {currentShout && (
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-yellow-600 text-white font-bold px-4 py-2 rounded-full shadow-xl animate-bounce-y z-10 text-sm">
                            {currentShout}
                        </div>
                    )}
                    
                    {/* Lobi veya Oyun Görünümü */}
                    {sessionData.isGameStarted ? (
                        <Game 
                            players={sessionData.players} 
                            grid={sessionData.grid} 
                            onReset={resetGame} 
                            onCellClick={handleCellClick} 
                            onGenerateShout={generateShout}
                            generatingShout={generatingShout}
                            userId={userId}
                            winner={winner}
                        />
                    ) : (
                        <Lobby 
                            players={sessionData.players} 
                            onStart={startGame} 
                            onJoin={joinGame} 
                            onLeave={leaveGame} 
                            userId={userId}
                            currentSessionId={currentSessionId}
                        />
                    )}
                </div>
            );
        }

        // ReactDOM.createRoot kullanımı
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
